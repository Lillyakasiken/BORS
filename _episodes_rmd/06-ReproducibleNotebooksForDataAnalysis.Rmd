---
source: Rmd
title: "Week 6 Reproducible notebooks for data analysis"
teaching: 0
exercises: 0
questions: 
  - "here are questions"
  - "questions, tbd"
  - "by eva"
objectives: 
  - "tbd"
  - "by eva"
keypoints:
  - "tbd"
  - "by eva"
---


```{r, include=FALSE}
source("../bin/chunk-options.R")
knitr_fig_path("05-")
```

# 061-1-introduction

![]({{ page.root }}/fig/Repro_Kreislauf_horizontal_halb.png)

&nbsp;


This week we learn about

1. Graphical user interface (GUI) vs Code

2. R Projects

3. R Markdown
&nbsp;

&nbsp;

&nbsp;

&nbsp;




# 061-2-GUIvsCode: 1. GUI vs Code

&nbsp;

## Graphical user interface (GUI) vs. Code


Statistical analysis software packages with graphical user interfaces such as SPSS (often) provide an easy solution to data analysis because

- one can get started with an analysis without much overhead in having to learn to code 
- it is a convenient way of exploring the data is needed 
- figures and the statistical analysis are done at the end of the exploration

**But** it is often not clear anymore how exactly (and with which commands) those results were obtained. **Data analysis with GUI** not **reproducible**
 
An analysis that is not reproducible can be an issue since 

- it is easy to unintentionally introduce errors and 
- it is hard to get rid of errors 
- if you need to change some step in the middle of the analysis you have to restart from scratch
- you can not provide a workflow that others (or yourself in the future) can follow easily to reproduce the results

 **Recording all steps is tedious**
 To make your analysis reproducible (by yourself or others) it would be necessary to write down all steps that were done which can be very tedious. Even if some kind of history of the executed commands is saved it might still be necessary to clean this up and keep only the relevant steps.  
 
 **Learning to code is a big investment**
 On the other hand doing a statistical analysis purely with code seems to be a lot of effort since all steps have to be written down explicitly and in case of unfamiliarity with the used programming language some initial investment to get familiar with a new environment and maybe also some basic concepts of programming need to be learned. However, while it seems like a big hurdle modern programming languages designed for statistical computing, such as R, are usually pretty straightforward to learn and use.   
 
Furthermore text based analysis are **more flexible** since usually more combinations, functions and extensions are available. 

**Code based data analysis is more flexible** 
In R, for example, thousands of packages are available. Besides, written analyses are easily **reproducible** as all commands that have been executed are written down and if complemented with comments and descriptions are also easily understandable for humans. 

**Code based data analysis includes more details than narrative description** 
Such a coded analysis script provides a complete account of what has been calculated, much more complete than any narrative text on used methods could ever be. 

Another point not to underestimate are the many readily available analyses that can be copied and used as a starting point for your own analysis which greatly increases speed and reduces the amount of work. 

**Many code based data analysis types openly available** 
Related to that is the concept of reusing code if for instance you have similar parts in your analysis.  

To summarize:

* **Disadvantages**
  - need to code
  - writing instead of clicking
* **Advantages**
  - Flexible
  - Extensible (packages)
  - Reproducible (easily rerun from scratch)
  - Mixing code and text increases readability 
  - Complete account of analysis
  - start from similar analyses


&nbsp;

&nbsp;

&nbsp;

&nbsp;




# 061-4-RProject: 2. R Projects

&nbsp;

**R Projects allow easy implementation of a sensible directory structure** 
Another very useful concept in Rstudio are R Projects. They allow to easily implement the structures that we heard about in week 3 (Organisation and software). You start with a directory for each project, have your data, code results etc in subdirectories and the projects functionality of Rstudio allows you to communicate easily between these directories.   

**Bundle code and data** 
The main idea is that all files needed (scripts, data, ...) for an analysis are brought together to make your and your collaborators life easier. If you start a Project it automatically takes care of things like using the correct working directory and lets you quickly jump between different projects by remembering which files you had open and reopening them again.   

**R Projects set working directory**
Connected to the use of Project is the concept that you use relative file paths (e.g. for loading csv files). So instead of doing something like this: `read.csv("/home/user/Documents/Uni/Basics_of_Open_Science/Topic_5/data/example.csv")` you write `read.csv("data/example.csv")`. This is easier to write, more flexible and less prone to errors because as long as you keep your files in the project together it will work. Imagine for example you want to move your script (and data) to `"/home/user/backup/Uni/Basics_of_Open_Science/Topic_5/data/example.csv"`. 
**R Projects make collaboration easier**  
Your script won't work anymore and you have to manually adjust the file path. This gets even worse if multiple people work on the same analysis and every one has to change their scripts. 

**Easily work on different projects at once** 
Another advantage of R Projects is the possibility to quickly switch to another project without mixing up scripts and data between projects. Without using R Projects you probably have to close the files you have open, change the working directory to the new location, open the files you will be using and restart the R session. With R Projects this is all done automatically.

&nbsp;

&nbsp;

&nbsp;

&nbsp;




# 061-5-RMarkdown: 3. R Markdown

&nbsp;

R Markdown is a realisation of the **literate programming** concept mixing narrative text with analysis code which is then rendered into formated text and analysis results (numbers, tables and graphics). 
**Combine narrative and coded data analysis**
The concept of literate programming goes back to Donald Knuth, see e.g. from the [open-science-with-r carpentries course](https://carpentries-incubator.github.io/open-science-with-r/02-Rstudio/index.html):




> _
More generally, the mixture of code, documentation (conclusion, comments) and 
figures in a notebook is part of the so-called “literate programming” paradigm
(Donald Knuth, 1984). Your code and logical steps should be understandable for 
human beings. In particular these four tips are related to this paradigm:
_

>
- _Do not write your program only for R but think also of code readers (that 
  includes you)._
- _Focus on the logic of your workflow. Describe it in plain language (e.g. 
  English) to explain the steps and why you are doing them._
- _Explain the “why” and not the “how”._
- _Create a report from your analysis using a R Markdown notebook to wrap together 
  the data + code + text._




## Create new RMarkdown (.Rmd) file

Go to `File` > `New File` > `R Markdown`, enter `Title` and `Author`, select `html` as output, confirm.
A new .Rmd file should open with a short tutorial. 
**Execute these steps on your computer while you read** 
To render, or `knit`, the file to `html` press `Knit`. The first time you run the script you will have to specify the name under which to save it. Afterwards the script is always saved before rendering. 

An R Markdown file consists of multiple parts which we will discuss now.

## YAML header 

More information about the YAML header can be found in the [R Markdown cheat sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/rmarkdown.pdf).

Short summary from the [open-science-with-r carpentries course](https://carpentries-incubator.github.io/open-science-with-r/02-Rstudio/index.html):



> _
The header of your R Markdown document will allow you to personalize the related
report from your R Markdown document.
The header follows the YAML syntax (“YAML Ain’t Markup Language”) which usually
follows a key:value syntax.
_


For example, `title: "titlename"`, where `title` is the key and `"titlename"` is the value.

The header itself starts with `---` and stops with `---`. For example:

```
---
title: "titlename"
output: html_output
---
```


## Code Chunks


The narrative text is written in Markdown. Code chunks contain R code that is to be executed when rendering the chunk or the entire file, i.e. including the data analysis. A code chunk is delimited from plain text using the following syntax:
To start a chunk write (backticks) 
` ```{r} `, then place your R code and end the chunk with
` ``` `. The `r` in 
` ```{r} ` indicates that the programming language used in this chunk is R. Other options include `python` or
`bash` although we will not need these here.  
Within RStudio a new code chunk can be included by either clicking on `Insert a new code chunk` in the toolbar or using a keyboard shortcut (`Ctrl+Alt+I` on Windows and `Option+Command+I` on Mac).

To run the code in an individual chunk click on the green arrow (`Run Current Chunk`) on the right side of the chunk. 
**Each chunk can be run separately**
Alternatively use the keyboard shortcut `Ctrl+Alt+T` (Windows) or `Option+Command+T` (Mac) to run the current chunk (i.e. where your cursor is located). This runs only the code in the specific chunk but does not render the entire file.

For more options see the cheat sheet in R studio: `Help` > `Cheat Sheets` > `R Markdown Cheat Sheet` or the link above.



The behavior of the chunks can be changed by setting chunk options. This is done in the opening of the chunk, e.g. 
` ```{r, echo=FALSE}`, which hides the code of this chunk (while still evaluating it).  

&nbsp;

## Exercise

Modify the template found [here]({{ page.root }}/files/docs/06/061-5-RMarkdown_exercise_input.Rmd) by performing the following steps:

* add author and date to YAML header
* rename the first chunk to `print_chunk_nr_1`
* set the chunk options of chunk 2 to not show the code
* set the chunk options of chunk 3 to not evaluate the code but show it
* set the chunk options of chunk 4 to not show the warning
* complete the sentence at the end with appropriate information calculated in chunk 5

&nbsp;

&nbsp;

&nbsp;

&nbsp;




# 062homework

&nbsp;

```{r, include=FALSE}
show_results <- FALSE
hide_results <- function(input, show=TRUE){
  if(show){
    return(input)
  } else{
    return("")
  }
}
```

```{r, echo =FALSE}
library(palmerpenguins)
```

## Goal

The goal of the homework is to create a fully reproducible analysis within an R Markdown script which is easy to understand and read. For that, describe what you do and do not forget nice formatting. For example try different Markdown syntax (Headers, ...), figure captions (*Hint*: check the chunk options for this), a meaningful YAML header, ...


&nbsp;

## Submission

Once you have answered the questions below in "Part 2 - Data analysis" within your R Markdown script you need to upload it to http://imlspenticton.uzh.ch:3841 . Once it fulfills the formal requirements (i.e. has an appropriate YAML header), you can run a check on it to see if you find the correct answers. You may perform this check in total three times, the third time will be your final submission.

Your YAML header needs to contain `author` information (e.g. `author: FirstName LastName`) and your email address in the `email` key (e.g. `email: my_email@uzh.ch`). **Note that you need to use your UZH email address since this is how we check who uploads.**

Moreover you need to enter your submission for assessment on Open edX as well, such that we can transfer the points from the checked R Markdown script into the system.

Please be sure to do **both: upload an Rmd file and indicate your submission on Open edX!**


&nbsp;

## Part 1 - Preparation

We will use the `penguins` dataset from the package `palmerpenguins`. 

*Hint*: the `penguins` dataset is available as the variable `penguins` (after installing the package `palmerpenguins`) 

To get an overview of the data load the `penguins` dataset and do the following two steps. 


&nbsp;

### Step 1 

Find the the source of the `penguins` dataset together with the url to the data repository


*Hint*: run `?penguins`


&nbsp;

### Step 2

Create a Markdown table describing the `penguins` data:

- for each **numeric** column in the dataset create a row in the table which should consist of the following columns: `Column_Name`, `Mean`, `Variance`

*Hint*: Checkout the function `knitr::kable` and the chunk option `results='asis'`.


```{r, results='asis', include = show_results}
numericcols <- sapply(colnames(penguins), function(x) is.numeric(penguins[[x]]))
df <- data.frame(Column_Name = names(numericcols)[numericcols],
           Mean = signif(apply((na.omit(penguins[numericcols])),2,mean),4),
           Variance = signif(apply((na.omit(penguins[numericcols])),2,var),4),
           row.names = NULL
)
knitr::kable(df)
```


&nbsp;


## Part 2 - Data analysis

Create a new R Markdown document. You will write the code for each of the below questions in a separate chunk and describe the result in a complete sentence directly in the RMarkdown document. Additionally, you will input the answers directly into OpenEdX. For the automatic checks to work when you upload your Rmd script to the online app a special variable naming scheme is required. For each of the following 11 exercises assign the value of the result to a variable with the name `result_exercise_{NUMBER}` replacing `NUMBER` with the number of the respective exercise. For example for exercise 1:
```
result_exercise_1 <- 42
```
(assuming `42` is the correct answer here.)

*Hint*: inline r code can be run with 
``` `r ` ``` , placing the code after `r `.



### Exercise 2.1
(*Variable name for result: `result_exercise_1`*)
```{r, include=show_results}
result_exercise_1 <- dim(penguins)[1]
```

How many rows does the `penguins` dataset have? `r hide_results(result_exercise_1, show_results)`


### Exercise 2.2
(*Variable name for result: `result_exercise_2`*)
```{r, include=show_results}
result_exercise_2 <- min(penguins$year)
```

What is the first year of records in the data set? `r hide_results(result_exercise_2, show_results)`

### Exercise 2.3
(*Variable name for result: `result_exercise_3`*)
```{r, include=show_results}
result_exercise_3 <- sum(penguins$species == "Adelie")
```

What is the total number of Adelie penguins? `r hide_results(result_exercise_3, show_results)`

### Exercise 2.4
(*Variable name for result: `result_exercise_4`*)
```{r, include=show_results}
result_exercise_4 <- sum(is.na(penguins))
```

What is the total number of missing values (`NA`)?

Total number of missing values (NA's): `r hide_results(result_exercise_4, show_results)`

### Exercise 2.5
(*Variable name for result: `result_exercise_5`*)
```{r, include=show_results}
result_exercise_5 <- sum(apply(penguins,1, function(x) !any(is.na(x))))
```

What is the total number of rows with **no** missing values?

Number of complete rows (rows with no missing values, i.e. NA's): `r hide_results(result_exercise_5, show_results)`

### Exercise 2.6
(*Variable name for result: `result_exercise_6`*)
```{r, include=show_results}
result_exercise_6 <- unique(penguins$island[penguins$species == "Gentoo"]);
```

On which islands were the Gentoo penguins found?

Name of islands where the Gentoo penguins were found: `r hide_results(result_exercise_6, show_results)`

### Exercise 2.7
(*Variable name for result: `result_exercise_7`*)
```{r, include=show_results}
result_exercise_7 <- sum(penguins$species == "Adelie" & penguins$island == "Dream") / sum(penguins$island == "Dream")
```

What is the proportion of Adelie penguins on Dream island (compared to all penguins on Dream island)?

Proportion of Adelie penguins on Dream island: `r hide_results(result_exercise_7, show_results)`

### Exercise 2.8
(*Variable name for result: `result_exercise_8`*)
```{r, include=show_results}
result_exercise_8 <- quantile(na.omit(penguins$bill_length_mm), 0.93)
```

What is the 93% quantile of the bill lengths in mm?

93 % quantile of `bill_length_mm` : `r hide_results(result_exercise_8, show_results)`

### Exercise 2.9
(*Variable name for result: `result_exercise_9`*)
```{r, include=show_results}
result_exercise_9 <- abs(coef(lm(bill_depth_mm ~ sex, penguins))[2])
```

What is the absolute mean difference of  bill depth  in mm between female and male penguins?

Absolute mean difference of `bill_depth_mm` between female and male: `r hide_results(result_exercise_9, show_results)`

### Exercise 2.10
(*Variable name for result: `result_exercise_10`*)
```{r, include=show_results}
result_exercise_10 <- confint(lm(bill_depth_mm ~ sex, penguins),"sexmale" )
```

What is the 95% confidence interval of the slope of the linear regression with intercept of bill depth regressed on sex? Result will be a vector of two elements, e.g. `c('lower_limit', 'upper_limit')`.

95% confidence interval of slope of linear regression between `bill_depth_mm` and `sex`: `r hide_results(result_exercise_10, show_results)`

### Exercise 2.11
(*Variable name for result: `result_exercise_11`*)
```{r, include=show_results}
chins <- na.omit(penguins$species[penguins$flipper_length_mm < 205 & penguins$bill_length_mm > 45])
result_exercise_11 <- sum(chins == "Chinstrap")/length(chins)
```

What is the proportion of Chinstrap penguins with flipper length in mm smaller than 205 and bill length in mm larger than 45 compared to all penguins with flipper length in mm smaller than 205 and bill length in mm larger than 45?

Proportion of Chinstrap penguins with `flipper_length_mm` smaller than 205 and `bill_length_mm` larger than 45 compared to all penguins with `flipper_length_mm` smaller than 205 and `bill_length_mm` larger than 45: `r hide_results(result_exercise_11, show_results)`

### Exercise 2.12
(*Variable name for result: `result_exercise_12`*)
```{r, include=show_results}
result_exercise_12 <- sum(chins == "Chinstrap")/sum(penguins$species == "Chinstrap")
```

What is the proportion of Chinstrap penguins with `flipper_length_mm` smaller than 205 and `bill_length_mm` larger than 45 compared to all Chinstrap penguins?

Proportion of Chinstrap penguins with `flipper_length_mm` smaller than 205 and `bill_length_mm` larger than 45 compared to all Chinstrap penguins: `r hide_results(result_exercise_12, show_results)`

&nbsp;

&nbsp;

&nbsp;

&nbsp;




# 063in-classtask

&nbsp;

```{r, echo = F}
knitr::opts_chunk$set(out.extra = 'class="plot"')
```

# In-class tasks

In this exercise we will again look at the `penguins` dataset from the package `palmerpenguins`.  Of the 5 tasks given below 3 can be chosen to be completed while the remaining ones are optional.

```{r, echo=FALSE}
library(palmerpenguins)
```

## R Markdown tables

For the following exercise we will use the package `kableExtra` which extends the base capabilities of `knitr::kable` to create tables. 
From the package [vignette](http://haozhu233.github.io/kableExtra/awesome_table_in_html.html):


>## .
>The goal of kableExtra is to help you build common complex tables and manipulate 
>table styles. It imports the pipe %>% symbol from magrittr and verbalize all the
>functions, so basically you can add “layers” to a kable output in a way that is 
>similar with ggplot2 and plotly.
{: .callout}

For users who are not very familiar with the pipe operator %>% in R, it is the R 
version of the fluent interface. The ides is to pass the result along the chain 
for a more literal coding experience. Basically when we say A %>% B, technically 
it means sending the results of A to B as B’s first argument.


Simple tables can be generated as follows:
```{r}
library(kableExtra)
head(penguins) %>% # the dataset, '%>%' parses the output of this command as the input in the next command 
  kbl() %>% # the kableExtra equivalent of knitr::kable, base table
  kable_classic() # add theme to table
```

For all options check the documentation or the [vignette](http://haozhu233.github.io/kableExtra/awesome_table_in_html.html).


&nbsp;

## Task 1 Create the following table:

```{r, echo=FALSE, message=FALSE}
df_sum <- penguins %>% 
  dplyr::select(-sex,-island,-flipper_length_mm,-body_mass_g) %>% 
  dplyr::group_by(species,year) %>% 
  dplyr::summarise(dplyr::across(.fns = function(x) signif(mean(na.omit(x)),3))) %>% 
  tidyr::pivot_wider(names_from=c(year),values_from = c(bill_length_mm,bill_depth_mm)) 

df_sum %>%
  kbl(col.names = c("species",rep(c("2007","2008","2009"),2)))%>%
  kable_classic() %>%
  add_header_above(c(" " = 1, "bill length [mm]" = 3, "bill depth [mm]" = 3)) %>%
  kable_styling(bootstrap_options = c("hover")) %>% 
  column_spec (c(1,4),border_right = T) 

```

*Hint*: checkout the different styling functions, e.g. `kable_classic`.  
*Hint*: For multiple column names use `add_header_above`  
*Hint*: Use the following code to get started:  

```
df_sum <- penguins %>%   
  dplyr::select(-sex,-island,-flipper_length_mm,-body_mass_g) %>%   
  dplyr::group_by(species,year) %>%   
  dplyr::summarise(dplyr::across(.fns = function(x) signif(mean(na.omit(x)),3))) %>%   
  tidyr::pivot_wider(names_from=c(year),values_from = c(bill_length_mm,bill_depth_mm))   
```
  


&nbsp;

## Task 2 Create the following table:

```{r, echo=FALSE}
df_sum <- penguins %>% 
  dplyr::select(-island,-sex,-year,-body_mass_g,-flipper_length_mm) %>% 
  dplyr::group_by(species) %>% 
  dplyr::summarise(dplyr::across(.cols=!contains("species"), .fns = function(x) signif(mean(na.omit(x)),3))) %>% 
  dplyr::mutate(bill_length_boxplot="", bill_length_hist="",
                bill_depth_boxplot="", bill_depth_hist="")


dfsum_list <- split(penguins$bill_length_mm, penguins$species)
dfsum_list2 <- split(penguins$bill_depth_mm, penguins$species)
df_sum %>%
  dplyr::select(species, dplyr::starts_with("bill_length"), dplyr::starts_with("bill_depth")) %>% 
  kbl(col.names = c("species",rep(c("mean","boxplot","histogram"),2))) %>%
  kable_paper() %>%
  column_spec(1,border_right = TRUE) %>%
  column_spec(3, image = spec_boxplot(dfsum_list)) %>%
  column_spec(4, image = spec_hist(dfsum_list),border_right = T) %>%
  column_spec(6, image = spec_boxplot(dfsum_list2)) %>% 
  column_spec(7, image = spec_hist(dfsum_list2)) %>% 
  add_header_above(c(" " = 1, "bill length [mm]" = 3, "bill depth [mm]" = 3),
                   border_right = TRUE, border_left = TRUE)

```

*Hint*: Use `column_spec` for altering specific columns.
 
## Plots

In this part we will explore the `penguins` dataset using base R plotting functions.

## Task 3 Scatter plot

Create the following scatter plot of bill_depth_mm vs. body_mass_g and color by species using the function `plot`. Also add a legend.

```{r, echo=FALSE}
plot(bill_depth_mm ~ body_mass_g, penguins, col=penguins$species, pch=19)
legend(x="topright",legend=unique(penguins$species), col = seq_along(unique(penguins$species)), pch=19)
```


## Task 4 Histogram

Create the following histogram of flipper_length_mm for each island and color by island using `hist`. 

*Hint*: explore the argument `add`.  
*Hint*: checkout `rgb` for colors.

```{r, echo=FALSE}
colors_used <- c(Torgersen=rgb(0,1,0,0.4),Dream=rgb(0,0,1,0.4),Biscoe=rgb(1,0,0,0.4))
ylim_used <- c(0,0.07)
breaks_used <- seq(170,235,5)
par(mfrow=c(3,1),mar=c(4,4,2,0))
hist(penguins$flipper_length_mm[penguins$island == names(colors_used)[1]], col=colors_used[1],freq = FALSE, ylim = ylim_used, breaks = breaks_used, xlab = "Flipper length [mm]",main = names(colors_used)[1])
hist(penguins$flipper_length_mm[penguins$island == names(colors_used)[2]], col=colors_used[2],freq = FALSE, ylim = ylim_used, breaks = breaks_used, xlab = "Flipper length [mm]",main = names(colors_used)[2])
hist(penguins$flipper_length_mm[penguins$island == names(colors_used)[3]], col=colors_used[3],freq = FALSE, ylim = ylim_used, breaks = breaks_used, xlab = "Flipper length [mm]",main = names(colors_used)[3])
```


## Task 5 Boxplot

Create the following boxplot of `bill_length_mm` per species using `boxplot`. Also add a legend.

```{r, echo=FALSE}
colors_used <- c(Torgersen=rgb(0,1,0,0.4),Dream=rgb(0,0,1,0.4),Biscoe=rgb(1,0,0,0.4))
boxplot(bill_length_mm~species,penguins,col=colors_used, ylab="bill length [mm]")
points(bill_length_mm~species,penguins, pch=19)#, col=colors_used[penguins$species])
legend(x="topleft",legend=names(colors_used), col =colors_used, pch=19)
```

&nbsp;

## Upload

**Upload a pdf containing answers to all 5 tasks in the next step. Make sure the code to produce the answers is shown.** 


&nbsp;

&nbsp;

&nbsp;

&nbsp;


